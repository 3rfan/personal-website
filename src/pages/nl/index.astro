---
import BaseLayout from '../../layouts/BaseLayout.astro'
import IntroCard from '../../components/sections/IntroCard.astro'
import AboutMe from '../../components/sections/AboutMe.astro'
import Card from '../../components/Card.astro'
import ContactsCard from '../../components/sections/ContactsCard.astro'
import Now from '../../components/sections/Now.astro'
import ExperienceCard from '../../components/sections/ExperienceCard.astro'
import StudyCard from '../../components/sections/StudyCard.astro'
import { NavigationCard } from '../../components/sections/NavigationCard'
import {
  getLangFromUrl,
  useTranslations,
  useTranslatedPath,
  getRouteFromUrl,
} from '../../i18n/utils'
import { languages } from '../../i18n/ui'

const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)
const translatePath = useTranslatedPath(lang)
const route = getRouteFromUrl(Astro.url) || ''

// Generate paths for all languages
const languagePaths: Record<string, string> = {}
Object.keys(languages).forEach((l) => {
  languagePaths[l] = translatePath(route ? `/${route}` : '/', l)
})

const navigationTranslations = {
  about: t('about.title'),
  contacts: t('contacts.title'),
  experience: t('experience.title'),
  now: t('now.title'),
  portfolio: t('home.portfolio'),
}
---

<script>
  import { animate } from 'motion'
  import { loaderAnimation } from '../../lib/constants'

  let animationRunning = false
  let animationTimeout: ReturnType<typeof setTimeout> | null = null

  // Wait for ViewTransitions to complete before animating
  function initAnimations() {
    // Prevent multiple simultaneous animations
    if (animationRunning) return

    const cards = document.querySelectorAll('.card-animate')
    if (cards.length === 0) return

    // Clear any pending animation
    if (animationTimeout) {
      clearTimeout(animationTimeout)
      animationTimeout = null
    }

    animationRunning = true

    const sequence = [
      loaderAnimation,
      [
        cards,
        { y: ['40%', '0%'], opacity: [0, 1] },
        {
          at: '-0.1',
          duration: 0.4,
          delay: { easing: 'ease-out', from: 0, step: 0.3 },
        },
      ],
    ]

    animate.timeline(sequence).finished.then(() => {
      animationRunning = false
    })
  }

  // Handle ViewTransitions
  document.addEventListener('astro:after-swap', () => {
    // Wait for ViewTransition to complete and DOM to be ready
    animationTimeout = setTimeout(() => {
      initAnimations()
    }, 150)
  })

  // Initial load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initAnimations, 100)
    })
  } else {
    // DOM already loaded
    setTimeout(initAnimations, 100)
  }
</script>

<BaseLayout title={t('home.title')} description={t('home.description')}>
  <div
    slot="loader"
    class="loader bg-darkslate-700 fixed bottom-0 left-0 right-0 top-0 z-50 flex h-screen w-screen items-center justify-center text-3xl font-black uppercase text-neutral-50"
  >
  </div>
  <main
    class="relative m-auto grid w-full max-w-6xl gap-2 overflow-hidden p-2 sm:gap-2 sm:p-4 md:grid-cols-2 md:gap-3 md:p-6 lg:grid-cols-4 lg:grid-rows-8 lg:gap-4"
  >
    <Card colSpan="md:col-span-1" rowSpan="md:row-span-3">
      <NavigationCard
        currentLang={lang}
        currentRoute={route}
        languagePaths={languagePaths}
        translations={navigationTranslations}
        client:load
      />
    </Card>
    <IntroCard />
    <AboutMe />
    <Now />
    <Card
      colSpan="md:col-span-1"
      rowSpan="md:row-span-2"
      title={t('home.portfolio')}
      href={translatePath('/portfolio')}
    />
    <ContactsCard />
    <ExperienceCard />
    <StudyCard />
  </main>
</BaseLayout>
